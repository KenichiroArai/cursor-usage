<!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="versionModal" tabindex="-1" aria-labelledby="versionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="versionModalLabel">
                    <i class="bi bi-info-circle"></i> <span id="app-title">èª­ã¿è¾¼ã¿ä¸­...</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-tag"></i> ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
                                </h6>
                                <p class="card-text mb-2">
                                    <strong>ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> <span id="current-version">èª­ã¿è¾¼ã¿ä¸­...</span>
                                </p>
                                <p class="card-text mb-0">
                                    <strong>é–‹ç™ºãƒ»ç®¡ç†:</strong>
                                    <a id="github-link" href="#" target="_blank" rel="noopener" class="link-primary">
                                        <i class="bi bi-github"></i> <span id="github-text">èª­ã¿è¾¼ã¿ä¸­...</span>
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-graph-up"></i> æ©Ÿèƒ½æ¦‚è¦
                                </h6>
                                <ul id="features-list" class="mb-0">
                                    <li>æ©Ÿèƒ½æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                <a id="github-footer-link" href="#" target="_blank" rel="noopener" class="btn btn-primary">
                    <i class="bi bi-github"></i> GitHub ã§è©³ç´°ã‚’è¦‹ã‚‹
                </a>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’å‹•çš„ã«æ›´æ–°ã™ã‚‹
 */
async function updateVersionModal() {
    console.log('ğŸ¯ === updateVersionModalé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ ===');

    // versionLoaderãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å¾…æ©Ÿ
    if (!window.versionLoader) {
        console.error('âŒ window.versionLoaderãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        return;
    }
    console.log('âœ… window.versionLoaderãŒå­˜åœ¨ã—ã¾ã™');

    try {
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯èª­ã¿è¾¼ã‚€
        let versionInfo = window.versionLoader.getVersionInfo();
        if (!versionInfo) {
            console.log('ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            versionInfo = await window.versionLoader.loadVersionInfo();
        }

        console.log('å–å¾—ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:', versionInfo);

        // versionInfoãŒnullã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å–å¾—
        if (!versionInfo) {
            console.log('ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒnullã®ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™');
            versionInfo = window.versionLoader.getDefaultVersionInfo();
        }

        if (versionInfo) {
            console.log('ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚UIè¦ç´ ã‚’æ›´æ–°é–‹å§‹...');

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const titleElement = document.getElementById('app-title');
            if (titleElement) {
                const title = window.versionLoader.getTitle();
                titleElement.textContent = title;
                console.log('âœ… ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°:', title);
            } else {
                console.error('âŒ app-titleè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
            const versionElement = document.getElementById('current-version');
            if (versionElement) {
                const version = window.versionLoader.getCurrentVersion();
                versionElement.textContent = version;
                console.log('âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°:', version);
            } else {
                console.error('âŒ current-versionè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // GitHubãƒªãƒ³ã‚¯ã‚’æ›´æ–°
            const githubLink = document.getElementById('github-link');
            const githubFooterLink = document.getElementById('github-footer-link');
            const githubText = document.getElementById('github-text');
            const githubUrl = window.versionLoader.getGitHubUrl();

            if (githubLink) {
                githubLink.href = githubUrl;
                console.log('âœ… GitHubãƒªãƒ³ã‚¯ã‚’æ›´æ–°:', githubUrl);
            } else {
                console.error('âŒ github-linkè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            if (githubFooterLink) {
                githubFooterLink.href = githubUrl;
            }

            if (githubText && versionInfo.github?.issue_number) {
                const issueText = `GitHub Issue #${versionInfo.github.issue_number}`;
                githubText.textContent = issueText;
                console.log('âœ… GitHubãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°:', issueText);
            } else {
                console.error('âŒ github-textè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€issue_numberãŒã‚ã‚Šã¾ã›ã‚“');
            }

            // æ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            const featuresList = document.getElementById('features-list');
            if (featuresList) {
                const features = window.versionLoader.getFeatures();
                console.log('æ©Ÿèƒ½ãƒªã‚¹ãƒˆå–å¾—:', features, 'length:', features.length);
                if (features && features.length > 0) {
                    featuresList.innerHTML = features.map(feature => `<li>${feature}</li>`).join('');
                    console.log('âœ… æ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                } else {
                    console.warn('âŒ æ©Ÿèƒ½ãƒªã‚¹ãƒˆãŒç©ºã¾ãŸã¯æœªå®šç¾©ã§ã™');
                    featuresList.innerHTML = '<li>æ©Ÿèƒ½æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</li>';
                }
            } else {
                console.error('âŒ features-listè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            console.log('ğŸ‰ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ');
        } else {
            console.error('âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹éš›ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°
function initializeVersionModal() {
    console.log('ğŸ¯ version-modal åˆæœŸåŒ–ã‚’é–‹å§‹');

    const versionModal = document.getElementById('versionModal');
    if (versionModal) {
        console.log('âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
        versionModal.addEventListener('show.bs.modal', async function() {
            console.log('ğŸš€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ - updateVersionModal()ã‚’å‘¼ã³å‡ºã—ã¾ã™');
            try {
                await updateVersionModal();
            } catch (error) {
                console.error('âŒ updateVersionModal()ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
            }
        });
    } else {
        console.error('âŒ versionModalè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
    async function waitForVersionLoader(attempts = 0) {
        console.log(`ğŸ”„ waitForVersionLoader è©¦è¡Œ ${attempts + 1}/10`);
        if (window.versionLoader) {
            console.log('âœ… versionLoaderãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ');
            try {
                await updateVersionModal();
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–æ™‚ã®updateVersionModal()ã§ã‚¨ãƒ©ãƒ¼:', error);
            }
        } else if (attempts < 10) {
            console.log(`â³ versionLoaderã‚’å¾…æ©Ÿä¸­... (${attempts + 1}/10)`);
            setTimeout(() => waitForVersionLoader(attempts + 1), 200);
        } else {
            console.error('âŒ versionLoaderã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
        }
    }

    // åˆæœŸåŒ–ã‚’é–‹å§‹
    console.log('ğŸš€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™');
    waitForVersionLoader();
}

// DOMContentLoadedãŒæ—¢ã«ç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œã€ãã†ã§ãªã‘ã‚Œã°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeVersionModal);
} else {
    // DOM ã¯æ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€å³åº§ã«å®Ÿè¡Œ
    initializeVersionModal();
}
</script>
